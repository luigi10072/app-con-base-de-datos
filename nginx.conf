# nginx.conf
# Configuración para aplicaciones PHP en Railway

# Server block para redirigir HTTP a HTTPS
# Este bloque captura las solicitudes HTTP y las redirige a HTTPS.
# Railway maneja el proxying externo, pero esta es una buena práctica
# si tu Nginx interno necesita manejar redirecciones HTTP.
server {
    listen 80; # Escucha en el puerto HTTP estándar (interno del contenedor)
    listen [::]:80; # Para IPv6

    # ¡IMPORTANTE! Reemplaza 'your-app-domain.railway.app' con el dominio real de tu aplicación en Railway.
    # Por ejemplo, si tu URL es https://app-con-base-de-datos-production.up.railway.app/,
    # entonces tu server_name sería app-con-base-de-datos-production.up.railway.app
    server_name app-con-base-de-datos-production.up.railway.app; # <--- ¡REEMPLAZA ESTO!

    # Redirección permanente a HTTPS
    return 301 https://$host$request_uri;
}

# Server block principal para servir la aplicación en HTTPS (o el puerto interno de Railway)
server {
    listen 8080; # Railway expone el puerto 8080 para las aplicaciones
    listen [::]:8080; # Para IPv6

    root /app; # Directorio raíz de tu aplicación dentro del contenedor Railway

    # Orden de archivos de índice por defecto
    index index.html;

    # Configuración para servir archivos estáticos y manejar URLs limpias
    location / {
        try_files $uri $uri/ /index.html?$query_string;
        # Si prefieres que index.php sea la entrada principal para todas las rutas no estáticas:
        # try_files $uri $uri/ /index.php?$query_string;
    }

    # Configuración para pasar archivos .php a PHP-FPM
    location ~ \.php$ {
        try_files $uri =404; # Si el archivo PHP no existe, devuelve 404

        # Permitir explícitamente los métodos HTTP dentro de este bloque
        # Esto es crucial para solucionar el 405 Method Not Allowed
        limit_except GET POST PUT DELETE { deny all; }

        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass 127.0.0.1:9000; # Puerto común para PHP-FPM en buildpacks
        fastcgi_index index.php;

        include fastcgi_params;

        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param REQUEST_METHOD $request_method; # Asegura que el método original se pase a PHP
    }
}

