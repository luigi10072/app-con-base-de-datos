# nginx-app.conf
# Configuración de Nginx para tu aplicación PHP dentro del contenedor Docker

server {
    # Nginx escucha en el puerto proporcionado por la variable de entorno $PORT de Render
    listen $PORT default_server; 
    listen [::]:$PORT default_server;

    root /var/www/html; # Directorio donde está tu código dentro del contenedor

    index index.php index.html index.htm; # Orden de archivos de índice

    # Log de acceso y error
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Bloque principal para manejar solicitudes
    location / {
        try_files $uri $uri/ /index.html?$query_string;
        # Si prefieres que index.php sea la entrada principal para todas las rutas no estáticas:
        # try_files $uri $uri/ /index.php?$query_string;
    }

    # Bloque para procesar archivos PHP
    location ~ \.php$ {
        try_files $uri =404; # Si el archivo PHP no existe, devuelve 404

        # Pasar la solicitud a PHP-FPM
        fastcgi_pass 127.0.0.1:9000; # Conexión TCP/IP a PHP-FPM
        fastcgi_index index.php;

        # Incluir los parámetros FastCGI estándar
        include fastcgi_params;

        # Parámetros adicionales para PHP-FPM
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param REQUEST_METHOD $request_method; # Asegura que el método original se pase

        # Opcional: Aumentar timeouts si las operaciones PHP son largas
        # fastcgi_read_timeout 300;
        # fastcgi_send_timeout 300;
    }

    # Bloque para evitar el acceso directo a archivos sensibles (si los tuvieras)
    location ~ /\.ht {
        deny all;
    }
}
